<html>
  <head>
    <title>Toastboard&mdash;The Breader Breadboard</title>
    <link href="main.css" rel="stylesheet" type="text/css">
    <link href="bootstrap.min.css" rel="stylesheet" type="text/css">
    <link href="bootstrap-theme.min.css" rel="stylesheet" type="text/css">
    <link rel="icon" href="/favicon.ico">
    <script type="text/javascript" src="d3.v3.min.js"></script>
    <script type="text/javascript" src="jquery-1.12.2.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>

<script type="text/javascript" src="toastboard.js/drawboard.js"></script>
<script type="text/javascript" src="toastboard.js/component.js"></script>
<script type="text/javascript" src="toastboard.js/graph.js"></script>

<body>
<div class="navbar navbar-inverse navbar-fixed-top">
  <div class="container"><div class="navbar-header"><a href="index.html" class="navbar-brand">Toastboard</a>
  <ul class="nav navbar-nav">

  </ul>
  </div></div>
</div>
<div class="container" style="height:50px" />
<div class="container theme-showcase">
  <div class="jumbotron">
  <div class="row">
    <form class="form-inline" id="componentForm">

      <div class="form-group">
        <select id="newcomponent" name="newcomponent" class="form-control">
        <option value="wire">Wire</option>
        <option value="diode">Diode</option>
        <option value="resistor">Resistor</option>
        <option value="component">Component</option>
        </select>
      </div>
      <div class="form-group">
      <label class="sr-only" for="startRow">Starting point</label>
      <div class="input-group">

      <div class="input-group-addon">Start: Row</div>
      <!--
            <select id="startSide" name="startSide" class="form-control" style="width: 100px">
        <option value="left">Left side</option>
        <option value="right">Right side</option>
        </select> -->
      <input type="text" class="form-control" id="startRow" style="width: 70px" placeholder="Row">
      <div class="input-group-addon">Pin</div>
      <select id="startPinNum" name="startPinNum" class="form-control" style="width: 70px">
      <option value="1">a</option>
      <option value="2">b</option>
      <option value="3">c</option>
      <option value="4">d</option>
      <option value="5">e</option>
      <option value="6">f</option>
      <option value="7">g</option>
      <option value="8">h</option>
      <option value="9">i</option>
      <option value="10">j</option>
      </select>
      </div>
      </div>
      <div class="form-group">
      <label class="sr-only" for="endRow">Ending point</label>
      <div class="input-group">
      <div class="input-group-addon">End: Row</div>
      <!--
        <select id="endSide" name="endSide" class="form-control" style="width: 100px">
        <option value="left">Left side</option>
        <option value="right">Right side</option>
        </select> -->
      <input type="text" class="form-control" id="endRow" style="width: 70px" placeholder="Row">
      <div class="input-group-addon">Pin</div>
      <select id="endPinNum" name="endPinNum" class="form-control" style="width: 70px">
      <option value="1">a</option>
      <option value="2">b</option>
      <option value="3">c</option>
      <option value="4">d</option>
      <option value="5">e</option>
      <option value="6">f</option>
      <option value="7">g</option>
      <option value="8">h</option>
      <option value="9">i</option>
      <option value="10">j</option>
      </select>
      </div>
      </div>

        <button type="submit" class="btn btn-secondary" value="add">Add</button>
        <button type="submit" class="btn btn-secondary" value="delete">Delete</button>

    </form>
</div>
    <div class="row">
    <div class="col-xs-6">
    
    <div class="controls" style="margin: 15px">
    <button type="button" class="btn btn-secondary" id="scanOnce">Scan once</button>
    <button type="button" class="btn btn-secondary" id="scanCon">Scan continuously</button>
    <button type="button" class="btn btn-secondary" id="stopScan">Stop scan</button>

    </div>
<div id="failedTests"></div>
<div id="breadboard">
  <svg width="500" height="300" id="board" />

</div>
  <div id="clearButtonDiv"></div>
<div id="timestamp"></div> 
</div>
<div class="col-xs-6">
    <form class="form-inline" id="graphForm">
    <div class="form-group">
    <div class="input-group">
      <div class="input-group-addon">Row</div>
      <input type="text" class="form-control" id="rowToGraph" placeholder="Number">
      <select class="form-control" id="sideToGraph">
        <option>Left</option>
        <option>Right</option>
      </select>
      </div>
      </div>
      <button type="submit" class="btn btn-secondary" id="graphButton">Graph row</button>
    </form>
  <div class="rightside">
  
  <div class="graph">
    <div id="selected-row"></div>


     
    <div id="graph-div">
      <svg width="500" height="300" id="graphviz"></svg>
    </div>
  </div>
    
  </div>
</div>
</div>
</div>

<script type="text/javascript">
var socket = io.connect(); 

var getTimeStampString = function() {
  var now = new Date();
  var date = [ now.getMonth() + 1, now.getDate(), now.getFullYear() ];
  var time = [ now.getHours(), now.getMinutes(), now.getSeconds() ];
  return date.join("/") + " " + time.join(":")
};

var fullRowToRowAndSide = function(row) {
  var r;
  var s;
  if (row < 24) {
    r = row + 1;
    s = "Left";
  } else {
    r = row - 23;
    s = "Right";
  }
  return [r,s];
};

var myBreadboard = new Breadboard();
var myGraph = new Graph();

// if we get an "info" emit from the socket server then console.log the data we receive
socket.on('info', function (data) {
  console.log("got data from websocket inside html page");
  console.log(data);
  var json = JSON.parse(data);
  console.log(json);
  if (json.oscillo) {
    var rands = fullRowToRowAndSide(json.oscillo.row);
    $("#graphviz").html("");
    myGraph.addData(json.oscillo);
    myGraph.drawGraph();
  } else if (json.rowsLeft) {
    myBreadboard.drawBreadboard(json);
    redrawComponents(myBreadboard);
    var timestring = getTimeStampString();
    $("#timestamp").html("<p><i>last synched " + timestring + "</i></p>");
  }

});

var startConfig = function() {
  $("#scanOnce").show();
  $("#scanCon").show();
  $("#stopScan").hide();
  enableGraphingForm();
}

var scanningConfig = function() {
  $("#scanOnce").hide();
  $("#scanCon").hide();
  $("#stopScan").show();
  disableGraphingForm();
}

var graphingConfig = function() {
  $("#scanOnce").hide();
  $("#scanCon").hide();
  $("#stopScan").show();
  disableGraphingForm();
}

var disableGraphingForm = function() {
  $("#rowToGraph").attr("disabled","disabled");
  $("#sideToGraph").attr("disabled","disabled");
  $("#graphButton").attr("disabled","disabled");
}

var enableGraphingForm = function() {
  $("#rowToGraph").removeAttr("disabled");
  $("#sideToGraph").removeAttr("disabled");
  $("#graphButton").removeAttr("disabled");
}

  $(document).ready(function() {
    // draw buttons nicely
    
    var getDataButton = document.getElementById("scanOnce");
    getDataButton.id = "scanOnce";
    getDataButton.innerHTML = "Scan once";
    getDataButton.className = "btn btn-secondary";
    getDataButton.addEventListener("click", function() {
      console.log("client asks for data");
      socket.emit("d","hello");
    });

    var continuousButton = document.getElementById("scanCon");
    continuousButton.id = "scanCon";
    continuousButton.innerHTML = "Scan continuously";
    continuousButton.className = "btn btn-secondary";
    continuousButton.addEventListener("click", function() {
      console.log("client asks for continuous scan");
      socket.emit("s","hello");
      scanningConfig();
    });

    var stopButton = document.getElementById("stopScan");
    stopButton.id = "stopScan";
    stopButton.innerHTML = "Stop scan";
    stopButton.className = "btn btn-secondary";
    stopButton.addEventListener("click", function() {
      console.log("client says stop scan");
      socket.emit("t","data");
      startConfig();
    });

    var clearBoardButton = document.createElement("button");
    clearBoardButton.innerHTML = "Clear Board";
    clearBoardButton.className = "btn btn-secondary";
    clearBoardButton.addEventListener("click", function() {
      myBreadboard.drawEmptyBreadboard();
    });

    $("#graphForm").submit(function(e) {
      e.preventDefault();
      var row = $("input#rowToGraph").val();
      var side = $("#sideToGraph").val();
      var rowString = "";
      row -= 1;
      if (side == "Right") {
        row +=24;
      }
      if (row < 10) {
        rowString = "0" + row;
      } else {
        rowString = "" + row;
      }
      console.log("graph row " + rowString + " on side " + side);
      graphingConfig();
      myGraph.clear();
      socket.emit("o",rowString);
    });

    $("form#componentForm").submit(function(e) {
      e.preventDefault();
      var action = $(document.activeElement).val();
      var startrow = ($("input#startrow").val() - 1);
      var startpin = ($("#startPinNum").val() - 1);
      var endrow = ($("input#endrow").val() - 1);
      var endpin = ($("#endPinNum").val() - 1);
      var component_type = $("#newcomponent").val();

      console.log(component_type + " start side " + startrow + " " + startpin + " end side " + endrow + " " + endpin);
      if (startpin > 4) {
        startrow += 24;
        startpin -= 5
      }
      if (endpin > 4) {
        endrow += 24;
        endpin -= 5;
      }
            console.log(component_type + " start side " + startrow + " " + startpin + " end side " + endrow + " " + endpin);
      if (action == "add") {
        var c = makeComponent(myBreadboard,component_type,startrow,startpin,endrow,endpin);
        c.draw();
        saveComponent(c);
      } else if (action == "delete") {
        var removeId = makeComponentId(component_type,startrow,startpin,endrow,endpin);
        console.log("we will delete " + removeId);

        var svg = myBreadboard.drawEmptyBreadboard();
        myBreadboard.redrawBoard(svg);
        redrawComponents(myBreadboard,removeId);

      }
    });

    var controlsDiv = document.getElementsByClassName("controls")[0];
    controlsDiv.appendChild(getDataButton);
    controlsDiv.appendChild(continuousButton);
    controlsDiv.appendChild(stopButton);

    var belowBoardDiv = document.getElementById("clearButtonDiv");
    belowBoardDiv.appendChild(clearBoardButton);

    $("#stopScan").toggle();

  var fakeJson = '{\"rowsLeft\":[3.3,\"f\",2.9,\"f\",\"f\",\"f\",\"f\",2.4,\"f\",\"f\",2.1,\"f\",\"f\",1.8,\"f\",\"f\",\"f\",\"f\",\"f\",\"f\",\"f\",\"f\",\"f\",\"f\"], \"rowsRight\":[\"f\",1.5,\"f\",\"f\",1.2,\"f\",0.7,\"f\",\"f\",\"f\",0.5,\"f\",\"f\",0.3,\"f\",\"f\",0.0,\"f\",\"f\",\"f\",\"f\",\"f\",\"f\",\"f\"]}';
  myBreadboard.drawBreadboard(JSON.parse(fakeJson));
  sessionStorage.setItem("boardstate",JSON.stringify({"components":[]}));

  });
</script>

</body>
</html>