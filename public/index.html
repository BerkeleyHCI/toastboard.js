<html>
  <head>
    <title>Toastboard&mdash;The Breader Breadboard</title>
    <link href="main.css" rel="stylesheet" type="text/css">
    <link href="bootstrap.min.css" rel="stylesheet" type="text/css">
    <link href="bootstrap-theme.min.css" rel="stylesheet" type="text/css">
    <link rel="icon" href="/favicon.ico">
    <script type="text/javascript" src="d3.v3.min.js"></script>
    <script type="text/javascript" src="jquery-1.12.2.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>

<script type="text/javascript" src="toastboard.js/drawboard.js"></script>
<script type="text/javascript" src="toastboard.js/component.js"></script>
<script type="text/javascript" src="toastboard.js/graph.js"></script>

<body>
<div class="navbar navbar-inverse navbar-fixed-top">
  <div class="container"><div class="navbar-header"><a href="index.html" class="navbar-brand">Toastboard</a>
  <ul class="nav navbar-nav">

  </ul>
  </div></div>
</div>
<div class="container" style="height:50px" />
<div class="container theme-showcase">
  <div class="jumbotron">
  <div class="row">
  <form class="form-inline" id="componentForm">
    <div class="form-group">
    <div class="input-group" id="add-group">
      <div class="input-group-addon">Add a</div>
        <select id="newcomponent" name="newcomponent" class="form-control">
        <option value="wire">Wire</option>
        <option value="diode">Diode</option>
        <option value="resistor">Resistor</option>
        <option value="component">Component</option>
        <option value="button">Button</option>
        <option value="ina128">INA128</option>
        </select>

      </div>
      </div>
      <div class="input-group" id="start-pin-group">
      <div class="input-group-addon">Choose a start pin</div>
      </div>
      <div class="input-group" id="end-pin-group">
      <div class="input-group-addon">Choose an end pin</div>
      </div>
      <button type="submit" class="btn btn-secondary" value="add" id="add">Add</button>
      <button type="submit" class="btn btn-secondary" value="cancel" id="cancel">Cancel</button>
      <button type="submit" class="btn btn-secondary" value="delete" id="deleteComp">Delete Component</button>
      <button type="submit" class="btn btn-secondary" value="cancelDelete" id="cancelDelete">Cancel</button>
  </form>

  <!--
    <form class="form-inline" id="componentForm">

      <div class="form-group">
        <select id="newcomponent" name="newcomponent" class="form-control">
        <option value="wire">Wire</option>
        <option value="diode">Diode</option>
        <option value="resistor">Resistor</option>
        <option value="component">Component</option>
        <option value="button">Button</option>
        <option value="ina128">INA128</option>
        </select>
      </div>
      <div class="form-group">
      <label class="sr-only" for="startRow">Starting point</label>
      <div class="input-group">

      <div class="input-group-addon">Start: Row</div> 
      <input type="text" class="form-control" id="startRow" style="width: 70px" placeholder="Row">
      <div class="input-group-addon">Pin</div>
      <select id="startPinNum" name="startPinNum" class="form-control" style="width: 80px">
      <option value="1">a</option>
      <option value="2">b</option>
      <option value="3">c</option>
      <option value="4">d</option>
      <option value="5">e</option>
      <option value="6">f</option>
      <option value="7">g</option>
      <option value="8">h</option>
      <option value="9">i</option>
      <option value="10">j</option>
      <option value="v">VDD</option>
      <option value="g">GND</option>
      </select>
      </div>
      </div>
      <div class="form-group">
      <label class="sr-only" for="endRow">Ending point</label>
      <div class="input-group">
      <div class="input-group-addon">End: Row</div>

      <input type="text" class="form-control" id="endRow" style="width: 70px" placeholder="Row">
      <div class="input-group-addon">Pin</div>
      <select id="endPinNum" name="endPinNum" class="form-control" style="width: 80px">
      <option value="1">a</option>
      <option value="2">b</option>
      <option value="3">c</option>
      <option value="4">d</option>
      <option value="5">e</option>
      <option value="6">f</option>
      <option value="7">g</option>
      <option value="8">h</option>
      <option value="9">i</option>
      <option value="10">j</option>
      <option value="v">VDD</option>
      <option value="g">GND</option>
      </select>
      </div>
      </div>

      <input type="text" class="form-control" id="resistance" style="width: 100px" placeholder="Resistance">

        <button type="submit" class="btn btn-secondary" value="add">Add</button>
        <button type="submit" class="btn btn-secondary" value="delete">Delete</button>

    </form> -->
</div>
    <div class="row">
    <div class="col-xs-6">
    
    <div class="controls" style="margin: 15px">
    <button type="button" class="btn btn-secondary" id="scanOnce">Scan once</button>
    <button type="button" class="btn btn-secondary" id="scanCon">Scan continuously</button>
    <button type="button" class="btn btn-secondary" id="stopScan">Stop scan</button>

    </div>

<div id="breadboard">
  <svg width="500" height="300" id="board" />

</div>
  <div id="clearButtonDiv">
    <button type="button" class="btn btn-secondary" id="clear">Clear Board</button>
    <button type="button" class="btn btn-secondary" id="print">Save Board</button>
  </div>
<div id="timestamp"></div> 
</div>
<div class="col-xs-6">
    <form class="form-inline" id="graphForm">
    <div class="form-group">
    <div class="input-group">
      <div class="input-group-addon">Row to Graph: </div>
      <input type="text" class="form-control" id="rowToGraph" placeholder="Row" style="width: 70px">
      <select class="form-control" id="sideToGraph" style="width: 70px">
        <option>Left</option>
        <option>Right</option>
      </select>
      </div>
      </div>
      <div class="form-group">
      <div class="input-group">
      <button type="submit" class="btn btn-secondary" id="graphButton">Start graphing</button>
        <button type="button" class="btn btn-secondary" id="stopGraph">Stop graphing</button>
        </div></div>
    </form>

  <div class="rightside">
  
  <div class="graph">
    <div id="selected-row"></div>


     
    <div id="graph-div">
      <svg width="500" height="300" id="graphviz"></svg>
    </div>
  </div>
    
  </div>
</div>
</div>
</div>

<script type="text/javascript">
var socket = io.connect(); 

var getTimeStampString = function() {
  var now = new Date();
  var date = [ now.getMonth() + 1, now.getDate(), now.getFullYear() ];
  var time = [ now.getHours(), now.getMinutes(), now.getSeconds() ];
  return date.join("/") + " " + time.join(":")
};

var fullRowToRowAndSide = function(row) {
  var r;
  var s;
  if (row < 24) {
    r = row + 1;
    s = "Left";
  } else {
    r = row - 23;
    s = "Right";
  }
  return [r,s];
};

var myBreadboard = new Breadboard();
var myGraph = new Graph();
var holder = new ComponentHolder();

// if we get an "info" emit from the socket server then console.log the data we receive
socket.on('info', function (data) {
  console.log("got data from websocket inside html page");
  console.log(data);
  var json = JSON.parse(data);
  console.log(json);
  if (json.oscillo) {
    var rands = fullRowToRowAndSide(json.oscillo.row);
    $("#graphviz").html("");
    myGraph.addData(json.oscillo);
    myGraph.drawGraph();
  } else if (json.rowsLeft) {
    myBreadboard.drawBreadboard(json);
    redrawComponents(myBreadboard);
    myBreadboard.attachPinClickEvents();
    var timestring = getTimeStampString();
    $("#timestamp").html("<p><i>last synched " + timestring + "</i></p>");
  }

});

var startConfig = function() {
  $("#scanOnce").show();
  $("#scanCon").show();
  $("#stopScan").hide();
  $("#stopGraph").hide();
  enableGraphingForm();
}

var scanningConfig = function() {
  $("#scanOnce").hide();
  $("#scanCon").hide();
  $("#stopScan").show();
  disableGraphingForm();
}

var graphingConfig = function() {
  $("#scanOnce").hide();
  $("#scanCon").hide();
  $("#stopScan").hide();
  $("#stopGraph").show();
  disableGraphingForm();
}

var disableGraphingForm = function() {
  $("#rowToGraph").attr("disabled","disabled");
  $("#sideToGraph").attr("disabled","disabled");
  //$("#graphButton").attr("disabled","disabled");
  $("#graphButton").hide();
}

var enableGraphingForm = function() {
  $("#rowToGraph").removeAttr("disabled");
  $("#sideToGraph").removeAttr("disabled");
  //$("#graphButton").removeAttr("disabled");
  $("#graphButton").show();
}

var setStartPin = function(pinNum) {
  $("#start-pin-group").hide();
  $("#end-pin-group").show();
  var rowAndPin = getRowAndPinFromPinIndex(pinNum);
  holder.startRow = rowAndPin[0];
  holder.startPin = rowAndPin[1];
  svg = myBreadboard.drawEmptyBreadboard();
  myBreadboard.redrawBoard(svg);
  redrawComponents(myBreadboard);
  myBreadboard.attachPinClickEvents("end");
}
var setEndPin = function(pinNum) {
  $("#add-group").show();
  $("#start-pin-group").hide();
  $("#end-pin-group").hide();
  $("#add").show();
  $("#cancel").hide();
  var rowAndPin = getRowAndPinFromPinIndex(pinNum);
  holder.endRow = rowAndPin[0];
  holder.endPin = rowAndPin[1];
  var c = holder.create(myBreadboard);
  saveComponent(c);
  var svg = myBreadboard.drawEmptyBreadboard();
  myBreadboard.redrawBoard(svg);
  redrawComponents(myBreadboard);
}
var highlightComponentAndRedraw = function(id) {
  highlightStateComponent(id,"true");
  holder.id = id;
  var svg = myBreadboard.drawEmptyBreadboard();
  myBreadboard.redrawBoard(svg);
  redrawComponents(myBreadboard);
  $("#add-group").hide();
  $("#add").hide();
  $("#deleteComp").show();
  $("#cancelDelete").show();
}
var deleteHighlightedComponent = function() {
  var svg = myBreadboard.drawEmptyBreadboard();
  myBreadboard.redrawBoard(svg);
  redrawComponents(myBreadboard,holder.id);
  holder.empty();
};
var clearHighlightedComponent = function() {
  highlightStateComponent(holder.id,"false");
  holder.empty();
  var svg = myBreadboard.drawEmptyBreadboard();
  myBreadboard.redrawBoard(svg);
  redrawComponents(myBreadboard);
};

  $(document).ready(function() {
    // draw buttons nicely

    $("#resistance").hide();
    $("#cancel").hide();
    $("#start-pin-group").hide();
    $("#end-pin-group").hide();
    $("#deleteComp").hide();
    $("#cancelDelete").hide();
    
    $("#scanOnce").on("click",function() {
      socket.emit("d","hello");
    });

    $("#scanCon").on("click",function() {
      socket.emit("s","hello");
      scanningConfig();
    });

    $("#stopScan").on("click",function() {
      socket.emit("t","data");
      startConfig();
    })

    $("#stopGraph").on("click",function() {
      socket.emit("t","data");
      startConfig();
    });

    $("#clear").on("click",function() {
      myBreadboard.drawEmptyBreadboard();
      myBreadboard.attachPinClickEvents();
    });
    $("#print").on("click",function() {
      window.print();
    });

    var printButton = document.createElement("button");
    printButton.innerHTML = "Save Board";
    printButton.className = "btn btn-secondary";
    printButton.addEventListener("click", function() {
      window.print();
    });


    $("#graphForm").submit(function(e) {
      e.preventDefault();
      var row = $("input#rowToGraph").val();
      var side = $("#sideToGraph").val();
      var rowString = "";
      row -= 1;
      if (side == "Right") {
        row +=24;
      }
      if (row < 10) {
        rowString = "0" + row;
      } else {
        rowString = "" + row;
      }
      console.log("graph row " + rowString + " on side " + side);
      graphingConfig();
      myGraph.clear();
      socket.emit("o",rowString);
    });

    $("form#componentForm").submit(function(e) {
      e.preventDefault();
      var action = $(document.activeElement).val();
      if (action == "add") {
        holder.type = $("#newcomponent").val();
        svg = myBreadboard.drawEmptyBreadboard();
        myBreadboard.redrawBoard(svg);
        redrawComponents(myBreadboard);
        myBreadboard.attachPinClickEvents("start");
        $("#start-pin-group").show();
        $("#cancel").show();
        $("#add").hide();
        $("#add-group").hide();
      } else if (action == "cancel") {
        // redraw with no events
        holder.empty();
        svg = myBreadboard.drawEmptyBreadboard();
        myBreadboard.redrawBoard(svg);
        redrawComponents(myBreadboard);
        $("#start-pin-group").hide();
        $("#end-pin-group").hide();
        $("#cancel").hide();
        $("#add-group").show();
        $("#add").show();
      } else if (action == "delete") {
        deleteHighlightedComponent();
        $("#deleteComp").hide();
        $("#cancelDelete").hide();
        $("#add-group").show();
        $("#add").show();
      } else if (action == "cancelDelete") {
        clearHighlightedComponent();
        $("#deleteComp").hide();
        $("#cancelDelete").hide();
        $("#add-group").show();
        $("#add").show();
      }
    });
/*
    $("form#componentForm").submit(function(e) {
      e.preventDefault();
      var action = $(document.activeElement).val();
      var startrow = ($("input#startrow").val() - 1);
      var startpinraw = $("#startPinNum").val();
      if ($.isNumeric(startpinraw)) {
        var startpin = startpinraw - 1;
      } else {
        var startpin = startpinraw;
      }
      var endrow = ($("input#endrow").val() - 1);
      var endpinraw = $("#endPinNum").val();
      if ($.isNumeric(endpinraw)) {
        var endpin = endpinraw - 1;
      } else {
        var endpin = endpinraw;
      }
      var component_type = $("#newcomponent").val();
      var resistance = $("#resistance").val();

      console.log(component_type + " start side " + startrow + " " + startpin + " end side " + endrow + " " + endpin);
      if (startpin > 4) {
        startrow += 24;
        startpin -= 5
      }
      if (endpin > 4) {
        endrow += 24;
        endpin -= 5;
      }
            console.log(component_type + " start side " + startrow + " " + startpin + " end side " + endrow + " " + endpin);
      if (action == "add") {
        var c = makeComponent(myBreadboard,component_type,startrow,startpin,endrow,endpin);
        if (component_type == "resistor") {
          c.resistance = resistance;
        }
        c.draw();
        saveComponent(c);
      } else if (action == "delete") {
        var removeId = makeComponentId(component_type,startrow,startpin,endrow,endpin);
        console.log("we will delete " + removeId);

        var svg = myBreadboard.drawEmptyBreadboard();
        myBreadboard.redrawBoard(svg);
        redrawComponents(myBreadboard,removeId);
        myBreadboard.attachPinClickEvents();

      }
    });
    */

    $("#newcomponent").change(function(e) {
      if ($("#newcomponent").val() == "resistor") {
        $("#resistance").show();
      } else {
        $("#resistance").hide();
      }
    });

    $("#stopScan").toggle();
    $("#stopGraph").hide();

//Case 3, Right
/*
  var fakeJson = '{\"rowsLeft\":[\"f\",\"f\",\"f\",\"f\",\"f\",\"f\",1.5,0.0,0.0,3.3,\"f\",\"f\",\"f\",\"f\",\"f\",\"f\",\"f\",\"f\",\"f\",\"f\",\"f\",\"f\",\"f\",\"f\"], \"rowsRight\":[\"f\",\"f\",\"f\",\"f\",\"f\",\"f\",1.3,3.3,3.3,0.0,\"f\",\"f\",\"f\",\"f\",\"f\",\"f\",\"f\",\"f\",\"f\",\"f\",\"f\",\"f\",\"f\",\"f\"]}';
*/

//Case 3, Left

  var fakeJson = '{\"rowsLeft\":[\"f\",\"f\",\"f\",\"f\",\"f\",\"f\",1.5,0.0,0.0,0.0,\"f\",\"f\",\"f\",\"f\",\"f\",\"f\",\"f\",\"f\",\"f\",\"f\",\"f\",\"f\",\"f\",\"f\"], \"rowsRight\":[\"f\",\"f\",\"f\",\"f\",\"f\",\"f\",1.3,3.3,3.3,\"f\",\"f\",\"f\",\"f\",\"f\",\"f\",\"f\",\"f\",\"f\",\"f\",\"f\",\"f\",\"f\",\"f\",\"f\"]}';


  myBreadboard.drawBreadboard(JSON.parse(fakeJson));
  sessionStorage.setItem("boardstate",JSON.stringify({"components":[]}));
//  myBreadboard.attachPinClickEvents();

  });
</script>

</body>
</html>